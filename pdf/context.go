package pdf

import (
	"io"

	"github.com/go-pdf/fpdf"
)

// constants & variables ******************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// public functions ***********************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// Init
// ****************************************************************************************************************************************
func Init(args ...Option) PDF {
	opt, opts := getOptions([]Option{
		ColorOption("#383838"),
		FontSizeOption(12),
		FontRemOption(1),
		PageSizeOption(PageSizeA4),
		OrientationOption(Portrait),
		UnitOption(Millimeter),
		PageMarginOpiton(10, 10, 10),
		WidthOption(1),
	}, args...)

	ctx := &context{
		fpdf.New(opt.orientation, opt.unit, opt.pageSize, ""),
		opts,
	}
	ctx.Fpdf.SetFont("Arial", "B", opt.getFontSize())
	for i, j := range opt.fonts {
		ctx.Fpdf.AddUTF8FontFromBytes(i, "", j)
		if opt.font == "" {
			opt.font = i
			ctx.Fpdf.SetFont(opt.font, "", opt.getFontSize())
		}
	}
	ctx.AddPage()

	return ctx
}

// type defineds **************************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// context ********************************************************************************************************************************
type context struct {
	*fpdf.Fpdf
	options []Option
}

// PDF
// ****************************************************************************************************************************************
type PDF interface {
	AddPage(...Option)
	NewLine(...Option)
	Output(io.Writer) error
	Text(string, ...Option)
	Close()
}

// AddPage
// ****************************************************************************************************************************************
func (o *context) AddPage(args ...Option) {
	opt, _ := getOptions(o.options, args...)
	o.Fpdf.SetMargins(opt.marginLeft, opt.marginTop, opt.marginRight)
	o.Fpdf.AddPageFormat(opt.orientation, pageSizes[opt.pageSize][opt.unit])
}

// NewLine
// ****************************************************************************************************************************************
func (o *context) NewLine(args ...Option) {
	opt, _ := getOptions(o.options, args...)
	o.Fpdf.Ln(opt.getLineHeight())
}

// Output
// ****************************************************************************************************************************************
func (o *context) Output(writer io.Writer) (err error) {
	return o.Fpdf.Output(writer)
}

// Text
// ****************************************************************************************************************************************
func (o *context) Text(txt string, args ...Option) {
	opt, _ := getOptions(o.options, args...)

	w, mw := opt.getCellWidth(o.Fpdf)
	if w+o.Fpdf.GetX() > mw {
		o.NewLine()
	}

	r, g, b := opt.getTextColor()
	o.Fpdf.SetTextColor(r, g, b)
	o.Fpdf.SetFont(opt.font, "", opt.getFontSize())
	o.Fpdf.CellFormat(w, opt.getLineHeight(), txt, opt.getBorder(), 0, opt.getAlign(), false, 0, "")
}

// Close
// ****************************************************************************************************************************************
func (o *context) Close() {
	o.Fpdf.Close()
}

// private functions **********************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************
