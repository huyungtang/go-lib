package template

import (
	"bytes"
	"html/template"
	"io"
	"os"
	"sync"

	"github.com/tdewolff/minify"
	"github.com/tdewolff/minify/css"
	"github.com/tdewolff/minify/html"
)

// constants & variables ******************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// public functions ***********************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// Init
// ****************************************************************************************************************************************
func Init(opts ...Options) (tmp Template, err error) {
	p := &tmpl{
		buf: os.Stdout,
	}
	for _, opt := range opts {
		if err = opt(p); err != nil {
			return
		}
	}

	return p, nil
}

// type defineds **************************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// tmpl ***********************************************************************************************************************************
type tmpl struct {
	*template.Template
	tempOnce sync.Once
	buf      io.Writer
	mini     *minify.M
	miniOnce sync.Once
}

// init ***********************************************************************************************************************************
func (o *tmpl) init() *tmpl {
	o.tempOnce.Do(func() {
		o.Template = template.New("")
	})

	return o
}

// minifier *******************************************************************************************************************************
func (o *tmpl) minifier(reader io.Reader) (err error) {
	o.miniOnce.Do(func() {
		o.mini = minify.New()
		o.mini.AddFunc("text/css", css.Minify)
		o.mini.AddFunc("text/html", html.Minify)
	})

	return o.mini.Minify("text/html", o.buf, reader)
}

// Template
// ****************************************************************************************************************************************
type Template interface {
	// ExecuteTemplate(html_name, dto)
	ExecuteTemplate(string, interface{}) error
}

// ExecuteTemplate
// ****************************************************************************************************************************************
func (o *tmpl) ExecuteTemplate(name string, dto interface{}) (err error) {
	var buf bytes.Buffer
	if err = o.Template.ExecuteTemplate(&buf, name, dto); err != nil {
		return
	}

	return o.minifier(&buf)
}

// private functions **********************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************
