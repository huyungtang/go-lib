package file

import (
	"os"
	"regexp"

	"golang.org/x/text/encoding"
	"golang.org/x/text/encoding/traditionalchinese"
)

// constants & variables ******************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

var (
	Big5 Option = encodingOption(traditionalchinese.Big5)

	Append   Option = flagOption(os.O_CREATE | os.O_WRONLY | os.O_APPEND)
	Override Option = flagOption(os.O_CREATE | os.O_WRONLY | os.O_TRUNC)
)

// public functions ***********************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// FilterOption
// ****************************************************************************************************************************************
func FilterOption(pattern string) Option {
	return func(o *Context) {
		o.Filter = regexp.MustCompile(pattern)
	}
}

// OperationOption
// ****************************************************************************************************************************************
func OperationOption(op FileOp) Option {
	return func(o *Context) {
		o.Op = o.Op | op
	}
}

// PathOption
// ****************************************************************************************************************************************
func PathOption(pathes ...string) Option {
	return func(o *Context) {
		o.Path = append(o.Path, pathes...)
	}
}

// type defineds **************************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// Context
// ****************************************************************************************************************************************
type Context struct {
	encoding.Encoding
	Flag   int
	Filter *regexp.Regexp
	Op     FileOp
	Path   []string
}

// ApplyOptions
// ****************************************************************************************************************************************
func (o *Context) ApplyOptions(opts []Option, defa ...Option) (opt *Context) {
	opts = append(defa, opts...)
	for _, optFn := range opts {
		optFn(o)
	}

	return o
}

// Option
// ****************************************************************************************************************************************
type Option func(*Context)

// private functions **********************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// encodingOption *************************************************************************************************************************
func encodingOption(encode encoding.Encoding) Option {
	return func(o *Context) {
		o.Encoding = encode
	}
}

// flagOption *****************************************************************************************************************************
func flagOption(flag int) Option {
	return func(o *Context) {
		o.Flag = flag
	}
}
