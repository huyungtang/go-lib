package redis

import (
	"testing"

	"github.com/huyungtang/go-lib/cache"
	"github.com/huyungtang/go-lib/config"
	"github.com/huyungtang/go-lib/config/viper"
	"github.com/huyungtang/go-lib/file"
)

// constants & variables ******************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// public functions ***********************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// TestRedis
// ****************************************************************************************************************************************
func TestRedis(t *testing.T) {
	c, err := viper.Init(
		config.PathOption(file.PathWorking("../_testing")),
		config.EnvironmentOption("prod"),
	)
	if err != nil {
		t.Error(err)
	}

	var db cache.Database
	if db, err = Init(c.GetString("Redis", "")); err != nil {
		t.Error(err)
	}
	defer db.Close()

	var str string
	key1 := "testing:key1"
	if err = db.Get(key1, &str,
		cache.DefaultOption(func(i interface{}) (cache.Options, error) {
			if s, isOK := i.(*string); isOK {
				*s = "default value"
			}
			return cache.ExpireOption(30), nil
		}),
		cache.KeepTTLOption,
	); err != nil {
		t.Error(err)
	}

	if str != "default value" {
		t.Fail()
	}

	if err = db.Set(key1, "new value", cache.KeepTTLOption); err != nil {
		t.Error(err)
	}
}

// type defineds **************************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************

// private functions **********************************************************************************************************************
// ****************************************************************************************************************************************
// ****************************************************************************************************************************************
